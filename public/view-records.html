<!DOCTYPE html>
<html>
<head>
  <title>View Records</title>
  <style>
    body {
      background: linear-gradient(135deg, #6B7280, #9333EA);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #1F2937;
      font-size: 18px;
    }
    #header {
      position: sticky;
      top: 0;
      width: 100%;
      background: #14B8A6;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 2;
      box-sizing: border-box;
    }
    #header span { font-size: 20px; font-weight: bold; }
    #container {
      background: #FFFFFF;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      width: 100%;
      max-width: 90%;
      margin: 20px 0;
      box-sizing: border-box;
    }
    h2 { color: #4B5EAA; margin-bottom: 20px; font-weight: bold; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      overflow-x: auto;
      display: block;
    }
    th, td {
      border: 1px solid #D1D5DB;
      padding: 10px;
      text-align: center;
      min-width: 80px;
    }
    th {
      background: #2C5282;
      color: white;
      font-size: 18px;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    th:nth-child(2), td:nth-child(2) {
      position: sticky;
      left: 0;
      background: #F0F4F8;
      z-index: 3;
    }
    td:nth-child(2) { background: #F0F4F8; }
    tr:nth-child(even) { background: #F0F4F8; }
    tr:hover { background: #DBEAFE; }
    button {
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      background: #14B8A6;
      color: white;
      transition: background 0.3s;
    }
    button:hover { background: #2DD4BF; }
    .neutral-button { background: #9CA3AF; color: white; }
    .neutral-button:hover { background: #6B7280; }
    @media (max-width: 600px) {
      #container { padding: 20px; max-width: 100%; }
      table { font-size: 14px; }
      th, td { min-width: 60px; }
      #header { padding: 8px; }
    }
  </style>
</head>
<body>
  <div id="header">
    <button class="neutral-button" onclick="backToDashboard()" style="float: left;">‚Üê Back</button>
    <span id="classInfo"></span>
  </div>
  <div id="container">
    <h2>View Records</h2>
    <table id="recordsTable"></table>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const className = urlParams.get("class") || localStorage.getItem("currentClass");

    if (!className) {
      window.location.href = "/index.html";
      throw new Error("No className");
    }
    document.getElementById("classInfo").textContent = `Logged in as: ${className.toUpperCase()}`;

    Promise.all([
      fetch(`/get-subjects?class=${className}`),
      fetch(`/get-scores?class=${className}`)
    ])
      .then(([subjectsRes, scoresRes]) => Promise.all([subjectsRes.json(), scoresRes.json()]))
      .then(([subjects, data]) => {
        const table = document.getElementById("recordsTable");
        const upperSubjects = subjects.map(s => s.toUpperCase());
        const isScienceClass = className === "sss2b" || className === "sss3b";

        let headerRow = "<tr><th>S/N</th><th>Name</th>";
        upperSubjects.forEach(sub => {
          headerRow += `
            <th>${sub} 1st CA</th>
            <th>${sub} 2nd CA</th>
            <th>${sub} Exam</th>
            <th>${sub} Total</th>
            <th>${sub} Position</th>
            <th>${sub} Grade</th>
            <th>${sub} Class Average</th>
          `;
        });
        headerRow += "<th>Grand Total</th><th>Grand Average</th><th>Position (in Class)</th><th>Edit</th></tr>";
        table.innerHTML = headerRow;

        const studentsMap = {};
        data.records.forEach(record => {
          if (!studentsMap[record.serialNumber]) {
            studentsMap[record.serialNumber] = {
              serialNumber: record.serialNumber,
              name: record.studentName,
              scores: {},
              grandTotal: 0,
              grandAverage: "",
              classPosition: ""
            };
          }
          studentsMap[record.serialNumber].scores[record.subject] = {
            ca1: record.ca1 || 0,
            ca2: record.ca2 || 0,
            exam: record.exam || 0,
            total: record.total || 0,
            position: "",
            grade: "",
            classAverage: ""
          };
          studentsMap[record.serialNumber].grandTotal += record.total || 0;
        });

        const students = Object.values(studentsMap);
        const isSenior = className.startsWith("sss");

        students.forEach(student => {
          const maxScore = isScienceClass ? 1000 : subjects.length * 100;
          student.grandAverage = `${((student.grandTotal / maxScore) * 100).toFixed(1)}%`;
        });
        const grandTotals = students.map(s => s.grandTotal).sort((a, b) => b - a);
        students.forEach(student => {
          const pos = grandTotals.indexOf(student.grandTotal) + 1;
          student.classPosition = getOrdinal(pos);
        });

        subjects.forEach(sub => {
          const subjectTotals = students.map(s => s.scores[sub]?.total || 0).sort((a, b) => b - a);
          const offeringStudents = students.filter(s => s.scores[sub]?.total > 0);
          const classAvg = offeringStudents.length > 0 
            ? (offeringStudents.reduce((sum, s) => sum + (s.scores[sub]?.total || 0), 0) / offeringStudents.length).toFixed(1) + "%"
            : "-";
          students.forEach(student => {
            const total = student.scores[sub]?.total || 0;
            student.scores[sub] = student.scores[sub] || { ca1: 0, ca2: 0, exam: 0, total: 0, position: "-", grade: "-", classAverage: "-" };
            const pos = total > 0 ? subjectTotals.indexOf(total) + 1 : 0;
            student.scores[sub].position = total > 0 ? getOrdinal(pos) : "-";
            student.scores[sub].grade = total > 0 ? getGrade(total, isSenior) : "-";
            student.scores[sub].classAverage = isScienceClass ? (total > 0 ? `${total.toFixed(1)}%` : "-") : classAvg;
          });
        });

        students.forEach(student => {
          let row = `<tr><td>${student.serialNumber}</td><td>${student.name}</td>`;
          upperSubjects.forEach(sub => {
            const scores = student.scores[sub.toLowerCase()];
            row += `
              <td>${scores.ca1 === 0 && scores.ca2 === 0 && scores.exam === 0 ? "-" : scores.ca1}</td>
              <td>${scores.ca1 === 0 && scores.ca2 === 0 && scores.exam === 0 ? "-" : scores.ca2}</td>
              <td>${scores.ca1 === 0 && scores.ca2 === 0 && scores.exam === 0 ? "-" : scores.exam}</td>
              <td>${scores.ca1 === 0 && scores.ca2 === 0 && scores.exam === 0 ? "-" : scores.total}</td>
              <td>${scores.position}</td>
              <td>${scores.grade}</td>
              <td>${scores.classAverage}</td>
            `;
          });
          row += `
            <td>${student.grandTotal}</td>
            <td>${student.grandAverage}</td>
            <td>${student.classPosition}</td>
            <td><button onclick="editRecord('${student.serialNumber}', '${subjects[0]}')">Edit</button></td>
          </tr>`;
          table.innerHTML += row;
        });
      })
      .catch(error => {
        alert("Error loading records: " + error.message);
        window.location.href = "/index.html";
      });

    function getOrdinal(n) {
      if (n === 0) return "";
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function getGrade(total, isSenior) {
      if (isSenior) {
        if (total >= 85) return "A1";
        if (total >= 80) return "B2";
        if (total >= 60) return "C4";
        if (total >= 53) return "C5";
        if (total >= 50) return "C6";
        if (total >= 45) return "D7";
        if (total >= 40) return "E8";
        return "F9";
      } else {
        if (total >= 80) return "A";
        if (total >= 70) return "B";
        if (total >= 60) return "C";
        if (total >= 50) return "P";
        if (total >= 40) return "E";
        return "F";
      }
    }

    function editRecord(serial, subject) {
      window.location.href = `/edit-assessment.html?class=${className}&serial=${serial}&subject=${subject}`;
    }

    function backToDashboard() {
      window.location.href = `/dashboard.html?class=${className}`;
    }
  </script>
</body>
</html>