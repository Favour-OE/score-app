<!DOCTYPE html>
<html>
<head>
  <title>Records</title>
  <style>
    body {
      background: linear-gradient(135deg, #6B7280, #9333EA);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #1F2937;
      font-size: 18px;
    }
    #header {
      position: sticky;
      top: 0;
      width: 100%;
      background: #14B8A6;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 2;
      box-sizing: border-box;
    }
    #header span { font-size: 20px; font-weight: bold; }
    #records-container {
      background: #FFFFFF;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      width: 100%;
      max-width: 90%;
      margin: 20px 0;
      box-sizing: border-box;
    }
    h2 { color: #4B5EAA; margin-bottom: 20px; font-weight: bold; }
    select, input {
      background: white;
      border: 2px solid #D1D5DB;
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
      font-size: 18px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    select:focus, input:focus {
      border-color: #14B8A6;
      box-shadow: 0 0 5px rgba(20, 184, 166, 0.5);
      outline: none;
    }
    .invalid { border-color: #EF4444; animation: shake 0.3s; }
    .warning { color: #EF4444; font-size: 14px; margin: 2px 0; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      overflow-x: auto;
      display: block;
    }
    th, td {
      border: 1px solid #D1D5DB;
      padding: 10px;
      text-align: center;
      min-width: 80px;
    }
    th {
      background: #2C5282;
      color: white;
      font-size: 18px;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    td:nth-child(1), td:nth-child(2) {
      position: sticky;
      left: 0;
      background: #F0F4F8;
      z-index: 1;
    }
    th:nth-child(1) { left: 0; z-index: 3; }
    th:nth-child(2) { left: 80px; z-index: 3; }
    td:nth-child(2) { left: 80px; }
    tr:nth-child(even) { background: #F0F4F8; }
    tr:hover { background: #DBEAFE; }
    button {
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      margin: 8px;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.3s;
    }
    .action-button { background: #14B8A6; color: white; }
    .action-button:hover { background: #2DD4BF; }
    .neutral-button { background: #9CA3AF; color: white; }
    .neutral-button:hover { background: #6B7280; }
    #entry-form { margin-bottom: 20px; }
    .input-group { margin: 10px 0; }
    .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid #D1D5DB;
      border-top: 3px solid #14B8A6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @media (max-width: 600px) {
      #records-container { padding: 20px; max-width: 100%; }
      table { font-size: 14px; }
      th, td { min-width: 60px; }
      select, input { max-width: 100%; }
      #header { padding: 8px; }
    }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="header">
    <button class="neutral-button" onclick="backToDashboard()" style="float: left;">‚Üê Back</button>
    <span id="classInfo"></span>
    <button class="neutral-button" onclick="logout()" style="float: right;">Logout</button>
  </div>
  <div id="records-container">
    <h2 id="pageTitle"></h2>
    <div id="entry-form"></div>
    <table id="recordsTable"></table>
    <div id="spinner" class="spinner"></div>
  </div>

  <script>
    const TIMEOUT_MINUTES = 30;
    function checkTimeout() {
      const loginTime = localStorage.getItem("loginTime");
      if (loginTime) {
        const timeDiff = (Date.now() - parseInt(loginTime)) / 1000 / 60;
        if (timeDiff > TIMEOUT_MINUTES) {
          logout();
        }
      }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const currentClass = urlParams.get("class") || localStorage.getItem("currentClass") || "";
    const mode = urlParams.get("mode") || "view";
    if (!currentClass) window.location.href = "/index.html";
    document.getElementById("classInfo").textContent = `Logged in as: ${currentClass.toUpperCase()}`;
    document.getElementById("pageTitle").textContent = mode === "enter" ? "Enter Assessment Records" : "View Records";
    checkTimeout();

    let subjects = [];
    let scores = {};

    function loadEntryForm() {
      fetch(`/get-subjects?class=${currentClass}`)
        .then(response => response.json())
        .then(data => {
          subjects = data.map(s => s.toUpperCase()).sort();
          const form = document.getElementById("entry-form");
          form.innerHTML = `
            <input type="text" id="studentName" placeholder="Student Name"><br>
            <select id="subjectSelect"></select>
            <div class="input-group">
              <input type="number" id="caInput" placeholder="CA (0-40)">
              <div id="caWarning" class="warning"></div>
              <input type="number" id="examInput" placeholder="Exam (0-60)">
              <div id="examWarning" class="warning"></div>
            </div>
            <button class="action-button" onclick="saveScore()">Save</button>
            <button class="action-button" onclick="submitScores()">Submit All Records</button>
          `;
          const select = document.getElementById("subjectSelect");
          select.innerHTML = subjects.map(sub => `<option value="${sub}">${sub}</option>`).join("");
          select.value = subjects[0];
          subjects.forEach(sub => scores[sub] = { ca: "", exam: "" });

          document.getElementById("caInput").addEventListener("input", function() {
            this.classList.remove("invalid");
            const warning = document.getElementById("caWarning");
            warning.textContent = this.value && (this.value < 0 || this.value > 40) ? "CA must be 0-40" : "";
            const sub = select.value;
            scores[sub].ca = this.value === "" ? "" : parseInt(this.value);
          });
          document.getElementById("examInput").addEventListener("input", function() {
            this.classList.remove("invalid");
            const warning = document.getElementById("examWarning");
            warning.textContent = this.value && (this.value < 0 || this.value > 60) ? "Exam must be 0-60" : "";
            const sub = select.value;
            scores[sub].exam = this.value === "" ? "" : parseInt(this.value);
          });
        });
    }

    function saveScore() {
      const sub = document.getElementById("subjectSelect").value;
      const ca = scores[sub].ca;
      const exam = scores[sub].exam;
      if (ca !== "" && (ca < 0 || ca > 40)) {
        document.getElementById("caInput").classList.add("invalid");
        alert("CA must be 0-40!");
        return;
      }
      if (exam !== "" && (exam < 0 || exam > 60)) {
        document.getElementById("examInput").classList.add("invalid");
        alert("Exam must be 0-60!");
        return;
      }
      const nextIndex = subjects.indexOf(sub) + 1;
      if (nextIndex < subjects.length) {
        document.getElementById("subjectSelect").value = subjects[nextIndex];
        document.getElementById("caInput").value = scores[subjects[nextIndex]].ca || "";
        document.getElementById("examInput").value = scores[subjects[nextIndex]].exam || "";
        document.getElementById("caWarning").textContent = "";
        document.getElementById("examWarning").textContent = "";
      }
    }

    function submitScores() {
      const name = document.getElementById("studentName").value.trim();
      if (!name) { alert("Please enter a student name!"); return; }
      const scoreArray = Object.entries(scores).map(([subject, score]) => ({
        subject,
        ca: score.ca === "" ? 0 : score.ca,
        exam: score.exam === "" ? 0 : score.exam
      }));
      document.getElementById("spinner").style.display = "block";
      fetch("/submit-scores", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ class: currentClass, name, scores: scoreArray })
      })
        .then(response => response.text())
        .then(() => {
          document.getElementById("spinner").style.display = "none";
          if (confirm("Submission complete! Click OK to return to dashboard.")) {
            window.location.href = `/dashboard.html?class=${currentClass}`;
          }
        })
        .catch(error => {
          document.getElementById("spinner").style.display = "none";
          alert("Error submitting scores: " + error.message);
        });
    }

    function loadRecords() {
      fetch(`/get-scores?class=${currentClass}`)
        .then(response => response.json())
        .then(data => {
          const table = document.getElementById("recordsTable");
          subjects = data.subjects.map(s => s.toUpperCase());
          let headerRow = "<tr><th>S/N</th><th>NAMES</th>";
          subjects.forEach(sub => {
            headerRow += `<th>${sub} CA</th><th>${sub} EXAM</th><th>${sub} TOTAL</th><th>${sub} POSITION</th><th>${sub} GRADE</th><th>${sub} CLASS AVERAGE</th>`;
          });
          headerRow += "<th>GRAND TOTAL</th><th>GRAND AVERAGE</th><th>POSITION (IN CLASS)</th><th>Edit</th></tr>";
          table.innerHTML = headerRow;

          data.students.forEach(student => {
            let row = `<tr><td>${student.serialNumber}</td><td>${student.name}</td>`;
            subjects.forEach(sub => {
              const scores = student.scores[sub] || { ca: "", exam: "", total: "", position: "", grade: "", classAverage: "" };
              row += `<td>${scores.ca}</td><td>${scores.exam}</td><td>${scores.total}</td><td>${scores.position}</td><td>${scores.grade}</td><td>${scores.classAverage}</td>`;
            });
            row += `<td>${student.grandTotal}</td><td>${student.grandAverage}</td><td>${student.classPosition}</td>`;
            row += `<td><button class="action-button" onclick="editRecord('${student.serialNumber}')">Edit</button></td></tr>`;
            table.innerHTML += row;
          });
        });
    }

    function editRecord(serial) {
      window.location.href = `/edit.html?serial=${serial}&class=${currentClass}`;
    }

    function backToDashboard() { window.location.href = `/dashboard.html?class=${currentClass}`; }

    function logout() {
      localStorage.removeItem("currentClass");
      localStorage.removeItem("loginTime");
      window.location.href = "/index.html";
    }

    if (mode === "enter") {
      document.getElementById("recordsTable").style.display = "none";
      loadEntryForm();
    } else {
      document.getElementById("entry-form").style.display = "none";
      loadRecords();
    }
  </script>
</body>
</html>