<!DOCTYPE html>
<html>
<head>
  <title>Edit Record</title>
  <style>
    body {
      background: linear-gradient(135deg, #6B7280, #9333EA);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #1F2937;
      font-size: 18px;
    }
    #header {
      position: sticky;
      top: 0;
      width: 100%;
      background: #14B8A6;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 2;
      box-sizing: border-box;
    }
    #header span { font-size: 20px; font-weight: bold; }
    #edit-container {
      background: #FFFFFF;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      width: 100%;
      max-width: 600px;
      margin: 20px 0;
      box-sizing: border-box;
    }
    h2 { color: #4B5EAA; margin-bottom: 20px; font-weight: bold; }
    select, input {
      background: white;
      border: 2px solid #D1D5DB;
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
      font-size: 18px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    select:focus, input:focus {
      border-color: #14B8A6;
      box-shadow: 0 0 5px rgba(20, 184, 166, 0.5);
      outline: none;
    }
    .invalid { border-color: #EF4444; animation: shake 0.3s; }
    .warning { color: #EF4444; font-size: 14px; margin: 2px 0; }
    button {
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      margin: 8px;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.3s;
    }
    .action-button { background: #14B8A6; color: white; }
    .action-button:hover { background: #2DD4BF; }
    .neutral-button { background: #9CA3AF; color: white; }
    .neutral-button:hover { background: #6B7280; }
    .input-group { margin: 10px 0; }
    .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid #D1D5DB;
      border-top: 3px solid #14B8A6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @media (max-width: 600px) {
      #edit-container { padding: 20px; max-width: 100%; }
      select, input { max-width: 100%; }
      #header { padding: 8px; }
    }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="header">
    <button class="neutral-button" onclick="backToRecords()" style="float: left;">‚Üê Back</button>
    <span id="classInfo"></span>
    <button class="neutral-button" onclick="logout()" style="float: right;">Logout</button>
  </div>
  <div id="edit-container">
    <h2>Edit Record</h2>
    <div id="studentInfo"></div>
    <select id="subjectSelect"></select>
    <div class="input-group">
      <input type="number" id="caInput" placeholder="CA (0-40)">
      <div id="caWarning" class="warning"></div>
      <input type="number" id="examInput" placeholder="Exam (0-60)">
      <div id="examWarning" class="warning"></div>
    </div>
    <button class="action-button" onclick="saveScore()">Save</button>
    <button class="action-button" onclick="submitEdits()">Submit</button>
    <div id="spinner" class="spinner"></div>
  </div>

  <script>
    const TIMEOUT_MINUTES = 30;
    function checkTimeout() {
      const loginTime = localStorage.getItem("loginTime");
      if (loginTime) {
        const timeDiff = (Date.now() - parseInt(loginTime)) / 1000 / 60;
        if (timeDiff > TIMEOUT_MINUTES) {
          logout();
        }
      }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const currentClass = urlParams.get("class") || localStorage.getItem("currentClass") || "";
    const serial = urlParams.get("serial");
    if (!currentClass || !serial) window.location.href = "/index.html";
    document.getElementById("classInfo").textContent = `Logged in as: ${currentClass.toUpperCase()}`;
    checkTimeout();

    let subjects = [];
    let originalScores = {};
    let editedScores = {};

    fetch(`/get-scores?class=${currentClass}`)
      .then(response => response.json())
      .then(data => {
        subjects = data.subjects.map(s => s.toUpperCase()).sort();
        const student = data.students.find(s => s.serialNumber == serial);
        if (!student) window.location.href = `/records.html?class=${currentClass}&mode=view`;
        document.getElementById("studentInfo").textContent = `Editing: ${student.name} (S/N: ${serial})`;
        subjects.forEach(sub => {
          const score = student.scores[sub] || { ca: 0, exam: 0 };
          originalScores[sub] = { ca: score.ca, exam: score.exam };
          editedScores[sub] = { ca: score.ca, exam: score.exam };
        });

        const select = document.getElementById("subjectSelect");
        select.innerHTML = subjects.map(sub => `<option value="${sub}">${sub}</option>`).join("");
        select.value = subjects[0];
        updateInputs();
      });

    function updateInputs() {
      const sub = document.getElementById("subjectSelect").value;
      document.getElementById("caInput").value = editedScores[sub].ca;
      document.getElementById("examInput").value = editedScores[sub].exam;
      document.getElementById("caWarning").textContent = "";
      document.getElementById("examWarning").textContent = "";
    }

    document.getElementById("subjectSelect").addEventListener("change", updateInputs);
    document.getElementById("caInput").addEventListener("input", function() {
      this.classList.remove("invalid");
      const warning = document.getElementById("caWarning");
      warning.textContent = this.value && (this.value < 0 || this.value > 40) ? "CA must be 0-40" : "";
      const sub = document.getElementById("subjectSelect").value;
      editedScores[sub].ca = this.value === "" ? 0 : parseInt(this.value);
    });
    document.getElementById("examInput").addEventListener("input", function() {
      this.classList.remove("invalid");
      const warning = document.getElementById("examWarning");
      warning.textContent = this.value && (this.value < 0 || this.value > 60) ? "Exam must be 0-60" : "";
      const sub = document.getElementById("subjectSelect").value;
      editedScores[sub].exam = this.value === "" ? 0 : parseInt(this.value);
    });

    function saveScore() {
      const sub = document.getElementById("subjectSelect").value;
      const ca = editedScores[sub].ca;
      const exam = editedScores[sub].exam;
      if (ca < 0 || ca > 40) {
        document.getElementById("caInput").classList.add("invalid");
        alert("CA must be 0-40!");
        return;
      }
      if (exam < 0 || exam > 60) {
        document.getElementById("examInput").classList.add("invalid");
        alert("Exam must be 0-60!");
        return;
      }
      const nextIndex = subjects.indexOf(sub) + 1;
      if (nextIndex < subjects.length) {
        document.getElementById("subjectSelect").value = subjects[nextIndex];
        updateInputs();
      }
    }

    function submitEdits() {
      const updates = Object.entries(editedScores)
        .filter(([sub, score]) => score.ca !== originalScores[sub].ca || score.exam !== originalScores[sub].exam)
        .map(([subject, score]) => ({ subject, ca: score.ca, exam: score.exam }));
      if (updates.length === 0) {
        window.location.href = `/records.html?class=${currentClass}&mode=view`;
        return;
      }
      document.getElementById("spinner").style.display = "block";
      fetch("/update-scores", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ class: currentClass, serialNumber: serial, scores: updates })
      })
        .then(response => response.text())
        .then(() => {
          document.getElementById("spinner").style.display = "none";
          alert("Edits submitted successfully!");
          window.location.href = `/records.html?class=${currentClass}&mode=view`;
        })
        .catch(error => {
          document.getElementById("spinner").style.display = "none";
          alert("Error submitting edits: " + error.message);
        });
    }

    function backToRecords() { window.location.href = `/records.html?class=${currentClass}&mode=view`; }

    function logout() {
      localStorage.removeItem("currentClass");
      localStorage.removeItem("loginTime");
      window.location.href = "/index.html";
    }
  </script>
</body>
</html>