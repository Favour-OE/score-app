<!DOCTYPE html>
<html>
<head>
  <title>Score Entry App</title>
  <style>
    body {
      background: linear-gradient(135deg, #6B7280, #9333EA);
      font-family: 'Times New Roman', Times, serif;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #1F2937;
    }
    #login-container {
      background: rgba(255, 255, 255, 0.9);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      animation: bounceIn 0.5s ease;
      position: relative;
      z-index: 1;
      width: 80%;
      max-width: 600px;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
      background-size: cover;
      opacity: 0.2;
      z-index: 0;
    }
    #header {
      position: fixed;
      top: 0;
      width: 100%;
      background: #14B8A6;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 2;
    }
    #app {
      background: rgba(255, 255, 255, 1);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      width: 80%;
      max-width: 600px;
      text-align: center;
      position: relative;
      z-index: 1;
      margin-top: 60px;
    }
    h2 { color: #4B5EAA; margin-bottom: 20px; }
    select, input {
      background: white;
      border: 2px solid #D1D5DB;
      border-radius: 8px;
      padding: 8px;
      margin: 5px 0;
      width: 300px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    select:focus, input:focus {
      border-color: #14B8A6;
      box-shadow: 0 0 5px rgba(20, 184, 166, 0.5);
      outline: none;
    }
    .invalid { border-color: #EF4444; animation: shake 0.3s; }
    .warning { color: #EF4444; font-size: 12px; margin: 2px 0; }
    button {
      background: #14B8A6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      margin: 5px;
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
    }
    button:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background: #5EEAD4;
      transform: scale(1.05);
    }
    .button-group { display: flex; justify-content: center; gap: 20px; margin: 10px 0; }
    #submitAll.pulse { animation: pulse 1.5s infinite; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      animation: fadeIn 0.5s ease;
    }
    th, td {
      border: 1px solid #D1D5DB;
      padding: 10px;
      text-align: center;
    }
    th { background: #4B5EAA; color: white; }
    tr:nth-child(even) { background: #F0F4F8; }
    tr:hover { background: #E2E8F0; transition: background 0.2s; }
    #recordsTable button {
      background: #4B5EAA;
      padding: 5px 10px;
      animation: pulse 1.5s infinite;
    }
    #recordsTable button:hover { background: #6B7280; }
    #status { color: #14B8A6; margin: 10px 0; }
    #progress { margin: 10px 0; }
    #progress span {
      display: inline-block;
      padding: 5px 10px;
      margin: 5px;
      border-radius: 5px;
      background: #D1D5DB;
    }
    #progress span.saved { background: #14B8A6; color: white; }
    @media (max-width: 600px) {
      #app, #login-container { width: 90%; }
      select, input { width: 100%; }
      .button-group { flex-direction: column; gap: 10px; }
      #header { font-size: 14px; padding: 8px; }
    }
    @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 60% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
  </style>
</head>
<body>
  <div id="header" style="display: none;">
    <span id="classInfo"></span>
    <button onclick="logout()" style="float: right;">Logout</button>
  </div>
  <div id="login-container">
    <h2>Teacher Login</h2>
    <input type="text" id="username" placeholder="Class Username"><br>
    <input type="password" id="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
  </div>

  <div id="app" style="display: none;">
    <h2>Enter Student Scores</h2>
    <input type="text" id="studentName" placeholder="Student Name"><br>
    <select id="subjectSelect"></select><br>
    <input type="number" id="caInput" placeholder="CA (0-40)"><div id="caWarning" class="warning"></div>
    <input type="number" id="examInput" placeholder="Exam (0-60)"><div id="examWarning" class="warning"></div>
    <div class="button-group">
      <button id="saveButton" onclick="saveSubjectScore()">Save Subject Score</button>
      <button onclick="undoLastSave()">Undo</button>
      <button id="submitAll" onclick="submitAllScores()" disabled>Submit All Scores</button>
    </div>
    <div id="status"></div>
    <div id="progress"></div>
    <div class="button-group">
      <button onclick="newEntry()">New Entry</button>
      <button onclick="toggleRecords()">Show Records</button>
    </div>
    <table id="recordsTable" style="display: none;"></table>
  </div>

  <script>
    let loggedIn = false;
    let currentClass = "";
    let subjects = [];
    let currentScores = {};
    let lastSaved = null;
    let currentSubjectIndex = 0;
    let currentSerial = null;

    function login() {
      const username = document.getElementById("username").value.toLowerCase().replace(/\s+/g, '');
      const password = document.getElementById("password").value;
      const classes = {
        "prenursery": "pre123", "nursery1": "nur1123", "nursery2": "nur2123",
        "basic1": "bas1123", "basic2": "bas2123", "basic3": "bas3123",
        "basic4": "bas4123", "basic5": "bas5123", "jss1": "jss1123",
        "jss2": "jss2123", "jss3": "jss3123", "sss1": "sss1123",
        "sss2": "sss2123", "sss3": "sss3123"
      };
      if (classes[username] === password) {
        currentClass = username;
        fetch(`/check-setup?class=${currentClass}`)
          .then(response => {
            if (!response.ok) throw new Error("Server error");
            return response.json();
          })
          .then(data => {
            if (!data.setupComplete) {
              window.location.href = `/setup.html?class=${currentClass}`;
            } else {
              subjects = data.subjects.map(s => s.toUpperCase());
              renderSubjectSelect();
              loggedIn = true;
              document.getElementById("header").style.display = "block";
              document.getElementById("classInfo").textContent = `Logged in as: ${currentClass.toUpperCase()}`;
              document.getElementById("app").style.display = "block";
              document.getElementById("login-container").style.display = "none";
              loadDraft();
              alert("Logged in as " + username + "!");
            }
          })
          .catch(error => {
            console.error("Login error:", error);
            alert("Login failed: " + error.message);
          });
      } else {
        alert("Wrong username or password!");
      }
    }

    function renderSubjectSelect() {
      const select = document.getElementById("subjectSelect");
      select.innerHTML = '<option value="">Select Subject</option>' + 
                         subjects.map(sub => `<option value="${sub}">${sub}</option>`).join("");
      if (subjects.length > 0) {
        select.value = subjects[currentSubjectIndex];
      }
      updateProgress();
      updateButtons();
    }

    function saveSubjectScore() {
      const subject = document.getElementById("subjectSelect").value;
      const caInput = document.getElementById("caInput");
      const examInput = document.getElementById("examInput");
      const ca = caInput.value === "" ? 0 : parseInt(caInput.value);
      const exam = examInput.value === "" ? 0 : parseInt(examInput.value);

      if (!subject) {
        alert("Please select a subject!");
        return;
      }
      if (ca > 40 || exam > 60) {
        if (ca > 40) caInput.classList.add("invalid");
        if (exam > 60) examInput.classList.add("invalid");
        alert("CA must be 0-40, Exam must be 0-60!");
        return;
      }

      lastSaved = { subject, ca: currentScores[subject]?.ca || 0, exam: currentScores[subject]?.exam || 0 };
      currentScores[subject] = { ca, exam };
      document.getElementById("status").textContent = `Score saved for ${subject}`;
      caInput.value = "";
      examInput.value = "";

      currentSubjectIndex = subjects.indexOf(subject);
      if (currentSubjectIndex < subjects.length - 1) {
        currentSubjectIndex++;
      }
      document.getElementById("subjectSelect").value = currentSubjectIndex < subjects.length ? subjects[currentSubjectIndex] : "";
      document.getElementById("submitAll").disabled = false;
      updateProgress();
      saveDraft();
      updateButtons();
    }

    function updateButtons() {
      const saveButton = document.getElementById("saveButton");
      const submitButton = document.getElementById("submitAll");
      if (currentSubjectIndex === subjects.length - 1 && subjects.every(sub => currentScores[sub])) {
        saveButton.disabled = true;
        submitButton.textContent = "Submit";
        submitButton.classList.add("pulse");
      } else {
        saveButton.disabled = false;
        submitButton.textContent = "Submit All Scores";
        submitButton.classList.remove("pulse");
      }
    }

    function undoLastSave() {
      if (!lastSaved) {
        alert("Nothing to undo!");
        return;
      }
      if (currentScores[lastSaved.subject]) {
        currentScores[lastSaved.subject] = { ca: lastSaved.ca, exam: lastSaved.exam };
        if (lastSaved.ca === 0 && lastSaved.exam === 0) delete currentScores[lastSaved.subject];
      }
      lastSaved = null;
      document.getElementById("status").textContent = "Last save undone";
      updateProgress();
      saveDraft();
      document.getElementById("submitAll").disabled = Object.keys(currentScores).length === 0;
      updateButtons();
    }

    function updateProgress() {
      const progress = document.getElementById("progress");
      progress.innerHTML = subjects.map(sub => `<span class="${currentScores[sub] ? 'saved' : ''}">${sub} ${currentScores[sub] ? '✔' : ''}</span>`).join("");
    }

    function saveDraft() {
      localStorage.setItem(`draft_${currentClass}`, JSON.stringify({
        name: document.getElementById("studentName").value.toUpperCase(),
        scores: currentScores,
        serial: currentSerial
      }));
    }

    function loadDraft() {
      const draft = localStorage.getItem(`draft_${currentClass}`);
      if (draft) {
        const { name, scores, serial } = JSON.parse(draft);
        document.getElementById("studentName").value = name;
        currentScores = scores;
        currentSerial = serial;
        document.getElementById("submitAll").disabled = Object.keys(currentScores).length === 0;
        currentSubjectIndex = 0;
        updateProgress();
        updateButtons();
      }
    }

    function submitAllScores() {
      if (!loggedIn) {
        alert("Please log in first!");
        return;
      }
      const name = document.getElementById("studentName").value.toUpperCase();
      if (!name) {
        alert("Please enter a student name!");
        return;
      }
      const scores = Object.entries(currentScores).map(([subject, score]) => ({
        subject,
        ca: score.ca,
        exam: score.exam
      }));
      if (scores.length === 0) {
        alert("Please save at least one subject score!");
        return;
      }
      fetch("/submit-scores", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ class: currentClass, name, scores, serial: currentSerial })
      })
        .then(response => {
          if (!response.ok) throw new Error("Submission failed");
          return response.text();
        })
        .then(text => {
          alert(text);
          newEntry();
          viewRecords();
        })
        .catch(error => {
          console.error("Submit error:", error);
          alert("Error submitting scores: " + error.message);
        });
    }

    function newEntry() {
      document.getElementById("studentName").value = "";
      document.getElementById("caInput").value = "";
      document.getElementById("examInput").value = "";
      document.getElementById("subjectSelect").value = subjects[0] || "";
      document.getElementById("status").textContent = "";
      currentScores = {};
      lastSaved = null;
      currentSerial = null;
      currentSubjectIndex = 0;
      document.getElementById("submitAll").disabled = true;
      localStorage.removeItem(`draft_${currentClass}`);
      updateProgress();
      updateButtons();
    }

    function toggleRecords() {
      const table = document.getElementById("recordsTable");
      const button = document.querySelector("button[onclick='toggleRecords()']");
      if (table.style.display === "none") {
        viewRecords();
        table.style.display = "block";
        button.textContent = "Hide Records";
      } else {
        table.style.display = "none";
        button.textContent = "Show Records";
      }
    }

    function viewRecords() {
      fetch(`/get-scores?class=${currentClass}`)
        .then(response => response.json())
        .then(data => {
          const table = document.getElementById("recordsTable");
          table.innerHTML = "<tr><th>S/N</th><th>Name</th>" + subjects.map(sub => `<th colspan="2">${sub}</th>`).join("") + "<th>Edit</th></tr>" +
                            "<tr><th></th><th></th>" + subjects.map(() => `<th>CA</th><th>Exam</th>`).join("") + "<th></th></tr>";
          const studentData = {};
          data.forEach(entry => {
            if (!studentData[entry["Serial Number"]]) {
              studentData[entry["Serial Number"]] = { sn: entry["Serial Number"], name: entry["Student Name"], scores: {} };
            }
            studentData[entry["Serial Number"]].scores[entry.Subject] = { ca: entry.CA, exam: entry.Exam };
          });
          Object.values(studentData).forEach((student, index) => {
            table.innerHTML += "<tr><td>" + student.sn + "</td><td>" + student.name + "</td>" +
                              subjects.map(sub => `<td>${student.scores[sub]?.ca || ""}</td><td>${student.scores[sub]?.exam || ""}</td>`).join("") +
                              `<td><button onclick="editRecord(${index})">Edit</button></td></tr>`;
          });
        })
        .catch(error => console.error("View records error:", error));
    }

    function editRecord(index) {
      fetch(`/get-scores?class=${currentClass}`)
        .then(response => response.json())
        .then(data => {
          const studentData = {};
          data.forEach(entry => {
            if (!studentData[entry["Serial Number"]]) {
              studentData[entry["Serial Number"]] = { sn: entry["Serial Number"], name: entry["Student Name"], scores: {} };
            }
            studentData[entry["Serial Number"]].scores[entry.Subject] = { ca: entry.CA, exam: entry.Exam };
          });
          const student = Object.values(studentData)[index];
          document.getElementById("studentName").value = student.name;
          currentScores = { ...student.scores };
          currentSerial = student.sn;
          document.getElementById("submitAll").disabled = false;
          currentSubjectIndex = 0;
          updateProgress();
          saveDraft();
          updateButtons();
        })
        .catch(error => console.error("Edit record error:", error));
    }

    function logout() {
      document.getElementById("app").style.opacity = "0";
      setTimeout(() => {
        loggedIn = false;
        currentClass = "";
        subjects = [];
        document.getElementById("header").style.display = "none";
        document.getElementById("app").style.display = "none";
        document.getElementById("app").style.opacity = "1";
        document.getElementById("login-container").style.display = "block";
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
        localStorage.removeItem(`draft_${currentClass}`);
        alert("Logged out!");
      }, 300);
    }

    document.getElementById("caInput").addEventListener("input", function() {
      const value = this.value;
      const warning = document.getElementById("caWarning");
      this.classList.remove("invalid");
      if (value && (value < 0 || value > 40)) warning.textContent = "CA must be 0-40";
      else warning.textContent = "";
    });

    document.getElementById("examInput").addEventListener("input", function() {
      const value = this.value;
      const warning = document.getElementById("examWarning");
      this.classList.remove("invalid");
      if (value && (value < 0 || value > 60)) warning.textContent = "Exam must be 0-60";
      else warning.textContent = "";
    });
  </script>
</body>
</html>
