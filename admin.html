<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <style>
    body {
      background: linear-gradient(135deg, #6B7280, #9333EA);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #1F2937;
      font-size: 18px;
    }
    #header {
      position: sticky;
      top: 0;
      width: 100%;
      background: #14B8A6;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 2;
      box-sizing: border-box;
    }
    #header span { font-size: 20px; font-weight: bold; }
    #admin-container, #dashboard {
      background: #FFFFFF;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      width: 100%;
      max-width: 90%;
      margin: 20px 0;
      box-sizing: border-box;
    }
    #dashboard { display: none; }
    h2, h3 { color: #4B5EAA; margin-bottom: 20px; font-weight: bold; }
    input, select {
      background: white;
      border: 2px solid #D1D5DB;
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
      font-size: 18px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    select:focus, input:focus {
      border-color: #14B8A6;
      box-shadow: 0 0 5px rgba(20, 184, 166, 0.5);
      outline: none;
    }
    .password-container {
      position: relative;
      width: 100%;
      max-width: 300px;
      display: block;
      margin: 8px auto;
    }
    .password-container input {
      padding-right: 40px;
      width: 100%;
    }
    .eye-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 18px;
      color: #6B7280;
    }
    button, select.download-button {
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      margin: 8px;
      cursor: pointer;
      font-size: 18px;
      width: 100%;
      max-width: 200px;
      transition: background 0.3s;
    }
    .action-button, select.download-button { background: #14B8A6; color: white; }
    .action-button:hover, select.download-button:hover { background: #2DD4BF; }
    .delete-button { background: #EF4444; color: white; }
    .delete-button:hover { background: #DC2626; }
    .neutral-button { background: #9CA3AF; color: white; }
    .neutral-button:hover { background: #6B7280; }
    .button-group { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      overflow-x: auto;
      display: block;
    }
    th, td {
      border: 1px solid #D1D5DB;
      padding: 10px;
      text-align: center;
      min-width: 80px;
    }
    th {
      background: #2C5282;
      color: white;
      font-size: 18px;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    th:nth-child(2), td:nth-child(2) {
      position: sticky;
      left: 0;
      background: #F0F4F8;
      z-index: 3;
    }
    td:nth-child(2) { background: #F0F4F8; }
    tr:nth-child(even) { background: #F0F4F8; }
    tr:hover { background: #DBEAFE; }
    .spinner {
      display: none;
      width: 20px;
      height: 20px;
      border: 3px solid #D1D5DB;
      border-top: 3px solid #14B8A6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @media (max-width: 600px) {
      #admin-container, #dashboard { padding: 20px; max-width: 100%; }
      button, select { max-width: 100%; }
      table { font-size: 14px; }
      th, td { min-width: 60px; }
      #header { padding: 8px; }
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="header" style="display: none;">
    <button class="neutral-button" onclick="backToLogin()" style="float: left;">‚Üê Back</button>
    <span id="classInfo">Logged in as: ADMIN</span>
    <button class="neutral-button" onclick="logout()" style="float: right;">Logout</button>
  </div>
  <div id="admin-container">
    <h2>Admin Login</h2>
    <input type="text" id="adminUsername" placeholder="Admin Username"><br>
    <div class="password-container">
      <input type="password" id="adminPassword" placeholder="Admin Password">
      <span class="eye-icon" onclick="togglePassword()">üëÅÔ∏è</span>
    </div>
    <button class="action-button" onclick="adminLogin()">Login</button>
  </div>
  <div id="dashboard">
    <h2>Admin Dashboard</h2>
    <div class="button-group">
      <button class="action-button" onclick="downloadAllScores()">Download All Scores</button>
      <select class="download-button" onchange="downloadClassScores(this.value)">
        <option value="">Download Class Scores</option>
      </select>
    </div>
    <h3>Manage Records</h3>
    <select id="classSelect" onchange="loadRecords()"></select>
    <table id="recordsTable"></table>
    <div id="spinner" class="spinner"></div>
    <button class="delete-button" onclick="deleteSelected()">Delete Selected</button>
  </div>

  <script>
    const TIMEOUT_MINUTES = 30;
    function checkTimeout() {
      const loginTime = localStorage.getItem("loginTime");
      if (loginTime) {
        const timeDiff = (Date.now() - parseInt(loginTime)) / 1000 / 60;
        if (timeDiff > TIMEOUT_MINUTES) {
          logout();
          return true;
        }
        return false;
      }
      return true;
    }

    let adminLoggedIn = localStorage.getItem("adminLoggedIn") === "true";
    if (adminLoggedIn && !checkTimeout()) {
      showDashboard();
    } else {
      localStorage.removeItem("adminLoggedIn");
      localStorage.removeItem("loginTime");
      document.getElementById("admin-container").style.display = "block";
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("header").style.display = "none";
    }

    function togglePassword() {
      const passwordInput = document.getElementById("adminPassword");
      const eyeIcon = document.querySelector(".eye-icon");
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        eyeIcon.textContent = "üëÅÔ∏è‚Äçüó®Ô∏è";
      } else {
        passwordInput.type = "password";
        eyeIcon.textContent = "üëÅÔ∏è";
      }
    }

    function adminLogin() {
      const username = document.getElementById("adminUsername").value;
      const password = document.getElementById("adminPassword").value;
      fetch("/admin-login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      })
        .then(response => response.text())
        .then(text => {
          if (text === "Admin login successful!") {
            adminLoggedIn = true;
            localStorage.setItem("adminLoggedIn", "true");
            localStorage.setItem("loginTime", Date.now());
            showDashboard();
          } else {
            alert("Wrong username or password!");
          }
        })
        .catch(error => alert("Login error: " + error.message));
    }

    function showDashboard() {
      document.getElementById("admin-container").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("header").style.display = "block";
      loadClasses();
    }

    function loadClasses() {
      fetch("/get-classes")
        .then(response => response.json())
        .then(classes => {
          const classSelect = document.getElementById("classSelect");
          const downloadSelect = document.querySelector(".download-button");
          classSelect.innerHTML = '<option value="">Select Class</option>' + classes.map(cls => `<option value="${cls}">${cls}</option>`).join("");
          downloadSelect.innerHTML = '<option value="">Download Class Scores</option>' + classes.map(cls => `<option value="${cls}">${cls}</option>`).join("");
        });
    }

    function loadRecords() {
      const className = document.getElementById("classSelect").value;
      if (!className) return;
      fetch(`/get-scores?class=${className}`)
        .then(response => response.json())
        .then(data => {
          const table = document.getElementById("recordsTable");
          const subjects = data.subjects.map(s => s.toUpperCase());
          const isScienceClass = className === "sss2b" || className === "sss3b";

          // Build header row
          let headerRow = "<tr><th><input type='checkbox' onchange='toggleAll(this)'></th><th>S/N</th><th>NAMES</th>";
          subjects.forEach(sub => {
            headerRow += `
              <th>${sub} 1st CA</th>
              <th>${sub} 2nd CA</th>
              <th>${sub} Exam</th>
              <th>${sub} Total</th>
              <th>${sub} Position</th>
              <th>${sub} Grade</th>
              <th>${sub} Class Average</th>
            `;
          });
          headerRow += "<th>GRAND TOTAL</th><th>GRAND AVERAGE</th><th>POSITION (IN CLASS)</th></tr>";
          table.innerHTML = headerRow;

          // Group records into students
          const studentsMap = {};
          data.records.forEach(record => {
            if (!studentsMap[record.serialNumber]) {
              studentsMap[record.serialNumber] = {
                serialNumber: record.serialNumber,
                name: record.studentName,
                scores: {},
                grandTotal: 0,
                grandAverage: "",
                classPosition: ""
              };
            }
            studentsMap[record.serialNumber].scores[record.subject] = {
              ca1: record.ca1 || 0,
              ca2: record.ca2 || 0,
              exam: record.exam || 0,
              total: record.total || 0,
              position: "",
              grade: "",
              classAverage: ""
            };
            studentsMap[record.serialNumber].grandTotal += record.total || 0;
          });

          const students = Object.values(studentsMap);
          const isSenior = className.startsWith("sss");

          // Calculate grand averages and class positions
          students.forEach(student => {
            const offeredSubjects = Object.keys(student.scores).length;
            const maxScore = isScienceClass ? 1000 : subjects.length * 100; // 1000 for science, subjects * 100 for others
            student.grandAverage = `${((student.grandTotal / maxScore) * 100).toFixed(1)}%`;
          });
          const grandTotals = students.map(s => s.grandTotal).sort((a, b) => b - a);
          students.forEach(student => {
            const pos = grandTotals.indexOf(student.grandTotal) + 1;
            student.classPosition = getOrdinal(pos);
          });

          // Calculate subject-specific metrics
          subjects.forEach(sub => {
            const subjectTotals = students.map(s => s.scores[sub.toLowerCase()]?.total || 0).sort((a, b) => b - a);
            const offeringStudents = students.filter(s => s.scores[sub.toLowerCase()]?.total > 0);
            const classAvg = offeringStudents.length > 0 
              ? (offeringStudents.reduce((sum, s) => sum + (s.scores[sub.toLowerCase()]?.total || 0), 0) / offeringStudents.length).toFixed(1) + "%" // Average as % of 100 for science
              : "-";
            students.forEach(student => {
              const total = student.scores[sub.toLowerCase()]?.total || 0;
              student.scores[sub.toLowerCase()] = student.scores[sub.toLowerCase()] || { ca1: 0, ca2: 0, exam: 0, total: 0, position: "-", grade: "-", classAverage: "-" };
              const pos = total > 0 ? subjectTotals.indexOf(total) + 1 : 0;
              student.scores[sub.toLowerCase()].position = total > 0 ? getOrdinal(pos) : "-";
              student.scores[sub.toLowerCase()].grade = total > 0 ? getGrade(total, isSenior) : "-";
              student.scores[sub.toLowerCase()].classAverage = isScienceClass ? (total > 0 ? `${total.toFixed(1)}%` : "-") : classAvg; // Per-subject avg for science
            });
          });

          // Populate table rows
          students.forEach(student => {
            let row = `<tr><td><input type='checkbox' class='recordCheckbox' value='${student.serialNumber}'></td><td>${student.serialNumber}</td><td>${student.name}</td>`;
            subjects.forEach(sub => {
              const scores = student.scores[sub.toLowerCase()];
              row += `
                <td>${scores.ca1 === 0 && scores.ca2 === 0 && scores.exam === 0 ? "-" : scores.ca1}</td>
                <td>${scores.ca1 === 0 && scores.ca2 === 0 && scores.exam === 0 ? "-" : scores.ca2}</td>
                <td>${scores.ca1 === 0 && scores.ca2 === 0 && scores.exam === 0 ? "-" : scores.exam}</td>
                <td>${scores.ca1 === 0 && scores.ca2 === 0 && scores.exam === 0 ? "-" : scores.total}</td>
                <td>${scores.position}</td>
                <td>${scores.grade}</td>
                <td>${scores.classAverage}</td>
              `;
            });
            row += `<td>${student.grandTotal}</td><td>${student.grandAverage}</td><td>${student.classPosition}</td></tr>`;
            table.innerHTML += row;
          });
        });
    }

    function getOrdinal(n) {
      if (n === 0) return "";
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    function getGrade(total, isSenior) {
      if (isSenior) {
        if (total >= 85) return "A1";
        if (total >= 80) return "B2";
        if (total >= 60) return "C4";
        if (total >= 53) return "C5";
        if (total >= 50) return "C6";
        if (total >= 45) return "D7";
        if (total >= 40) return "E8";
        return "F9";
      } else {
        if (total >= 80) return "A";
        if (total >= 70) return "B";
        if (total >= 60) return "C";
        if (total >= 50) return "P";
        if (total >= 40) return "E";
        return "F";
      }
    }

    function toggleAll(source) {
      document.querySelectorAll(".recordCheckbox").forEach(cb => cb.checked = source.checked);
    }

    function deleteSelected() {
      const selected = Array.from(document.querySelectorAll(".recordCheckbox:checked")).map(cb => cb.value);
      if (selected.length === 0) { alert("Please select at least one record to delete!"); return; }
      const className = document.getElementById("classSelect").value;
      if (confirm(`Delete ${selected.length} records from ${className.toUpperCase()}?`)) {
        document.getElementById("spinner").style.display = "block";
        fetch("/delete-record", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ class: className, serialNumbers: selected })
        })
          .then(() => {
            document.getElementById("spinner").style.display = "none";
            loadRecords();
          })
          .catch(error => {
            document.getElementById("spinner").style.display = "none";
            alert("Delete error: " + error.message);
          });
      }
    }

    function downloadAllScores() {
      document.getElementById("spinner").style.display = "block";
      fetch("/download-all-scores")
        .then(response => {
          if (!response.ok) throw new Error("Download failed!");
          return response.blob();
        })
        .then(blob => {
          document.getElementById("spinner").style.display = "none";
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "all_scores.zip";
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        })
        .catch(error => {
          document.getElementById("spinner").style.display = "none";
          alert(error.message);
        });
    }

    function downloadClassScores(className) {
      if (!className) return;
      document.getElementById("spinner").style.display = "block";
      fetch(`/download-scores?class=${className}`)
        .then(response => {
          if (!response.ok) throw new Error("Download failed!");
          return response.blob();
        })
        .then(blob => {
          document.getElementById("spinner").style.display = "none";
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${className}_scores.xlsx`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
          document.querySelector(".download-button").value = "";
        })
        .catch(error => {
          document.getElementById("spinner").style.display = "none";
          alert(error.message);
        });
    }

    function backToLogin() { window.location.href = "/index.html"; }

    function logout() {
      adminLoggedIn = false;
      localStorage.removeItem("adminLoggedIn");
      localStorage.removeItem("loginTime");
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("header").style.display = "none";
      document.getElementById("admin-container").style.display = "block";
      document.getElementById("adminUsername").value = "";
      document.getElementById("adminPassword").value = "";
    }
  </script>
</body>
</html>